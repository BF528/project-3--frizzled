---
title: "R Notebook"
output: html_notebook
---

```{r}
BiocManager::install("DESeq2")
BiocManager::install("apeglm")
install.packages("hardhat", repos = "http://cran.us.r-project.org")
library(tidyverse)
library(DESeq2)
library("apeglm")
```


```{r}
library(hardhat)
library(stringr)
```

```{r}
# read in csv files 
# control counts
control_counts <- read_csv("~/Desktop/BF528/Project 3/control_counts.csv")
# extracting only columns for tox group 1
control_counts <- control_counts %>% select(Geneid, SRR1178000, SRR1178005, SRR1178007, SRR1177973, SRR1178016, SRR1178019)
counts_matrix <- read_csv("~/Desktop/BF528/Project 3/counts_matrix.csv")
# and convert them to tibbles
control_counts <- as_tibble(control_counts)
counts_matrix <- as_tibble(counts_matrix)
# change control counts "Geneid" to "gene_id"
names(control_counts)[names(control_counts) == "Geneid"] <- "gene_id"
```

```{r}
# we need to join the tables
de_combined_counts <- inner_join(counts_matrix, control_counts, by="gene_id")
```

```{r}
# filter out rows that have any zeros for funzies
de_combined_counts2 <- subset(de_combined_counts,rowSums(de_combined_counts==0)==0)
```

```{r}
# read in data with information for each group
info <- read_csv("~/Desktop/BF528/Project 3/toxgroup_1_rna_info.csv")
# convert to factor variable
info$mode_of_action <- factor(info$mode_of_action)
```

```{r}
# extract only control samples
controls <- info$Run[info$mode_of_action=="Control"] 
experimentals <- info$Run[info$mode_of_action!="Control"]
all_groups <- info$Run

# print each
controls
experimentals
all_groups
```

```{r}
# extract mode of actions
MOA_controls <- info$mode_of_action[info$mode_of_action=="Control"]
MOA_experimentals <- info$mode_of_action[info$mode_of_action!="Control"]
MOA <- info$mode_of_action

MOA_controls
MOA_experimentals
MOA
```

```{r}
# need to make first column in de_combined_counts2 the row names, so equal dimensions
de_combined_counts2 <- column_to_rownames(de_combined_counts2, var="gene_id")
```

```{r}
# need to be able to store deseq results
deseq_results <- list()  
deseq_results_tibble <- list() 
```

DESeq Analysis:
```{r}
# create the DESeq object
dds_init <- DESeqDataSetFromMatrix(
  countData = de_combined_counts2,
  colData = info,
  design= ~ mode_of_action
)

# relevel mode_of_action as factor
dds_init$mode_of_action <- relevel(dds_init$mode_of_action, ref='Control')

# run DESeq
dds_init <- DESeq(dds_init)
resultsNames(dds_init) # lists the coefficients

# normalized counts of all samples
normalized_counts <- counts(dds_init, normalized=TRUE)
write.csv(normalized_counts,'~/Desktop/BF528/Project 3/deseq_normalized_counts_final.csv')
```


```{r}
for (experimental_group in MOA_experimentals){
  # extract names of each experimental group
  exp_group_names <- info$Run[info$mode_of_action==experimental_group]
  print(exp_group_names)
  # only use control samples for tx group 1
  control_group_names <- info$vehicle[info$Run==exp_group_names][1]
  print(control_group_names)
  controls <- info$Run[info$vehicle==control_group_names & info$mode_of_action=="Control"]
  # subset names
  new_data_de <- de_combined_counts2[,c(exp_group_names, controls)]
  print(names(new_data_de)) # names of columns
  # subset info data
  new_data_info <- info[info$mode_of_action==experimental_group | (info$mode_of_action=="Control" & info$vehicle==control_group_names),]
  print(new_data_info)
  # need to make sure after subsetting, that the order of the genes match correctly
  matched_names <- length(names(new_data_de)) == sum(names(new_data_de)==new_data_info$Run)
  print(matched_names)
  if(matched_names){
    # create the DESeq object
    dds <- DESeqDataSetFromMatrix(
      countData = new_data_de,
      colData = new_data_info,
      design= ~ mode_of_action
    )
    
    # relevel mode_of_action as factor
    dds$mode_of_action <- relevel(dds$mode_of_action, ref='Control')
    
    # run DESeq
    dds <- DESeq(dds)
    res <- results(dds, contrast=c('mode_of_action', experimental_group,'Control'))
    res <- lfcShrink(dds, coef=2)
    # order results by adusted p-value
    res2 <- as_tibble(res, rownames=NA)
    res2 <- res2 %>% arrange(padj)
    # append results to list
    deseq_results[[experimental_group]] <- res
    deseq_results_tibble[[experimental_group]] <- res2
    # de results to csv
    #write.csv(res2,'~/Desktop/BF528/Project 3/deseq_results.csv')
  } 
}
```
```{r}
dds2 <- DESeqDataSetFromMatrix(
      countData = temp_tib,
      colData = temp_meta,
      design= ~ mode_of_action
    )
normalized_counts <- counts(dds2, normalized=TRUE)
    #write.csv(normalized_counts,'~/Desktop/BF528/Project 3/deseq_normalized_counts_final.csv')
```


Extracting top 10 significant genes
```{r}
deseq_results_2 <- list()
for (experimental_group in MOA_experimentals){
  # change row names to column
  deseq_results_2[[experimental_group]] <- rownames_to_column(deseq_results_tibble[[experimental_group]], var="gene_id")

  # new column names
  colnames(deseq_results_2[[experimental_group]]) <- paste(experimental_group, colnames(deseq_results_2[[experimental_group]]), sep="_")
} 


# generating csv for top 10
significant_10 <- bind_cols(deseq_results_2$AhR[c(1:10), c(1, 6)],
                          deseq_results_2$`CAR/PXR`[c(1:10), c(1, 6)], 
                          deseq_results_2$Cytotoxic[c(1:10), c(1, 6)])
write.csv(significant_10, "~/Desktop/BF528/Project 3/de_top10_significant.csv", row.names=FALSE)

number_of_significant_genes <- list()
deseq_significant <- list()

for (experimental_group in MOA_experimentals){
  deseq_significant[[experimental_group]] <- deseq_results_tibble[[experimental_group]][deseq_results_tibble[[experimental_group]]$padj < 0.05,]
  number_of_significant_genes[[experimental_group]] <- length(deseq_significant[[experimental_group]]$padj)
} 

# number of significant genes for each experimental_group
number_of_significant_genes
```

```{r}
# extracting significant genes for each group
AhR_significant <- deseq_significant$AhR
CAR.PXR_significant <- deseq_significant$`CAR/PXR`
Cytotoxic_significant <- deseq_significant$Cytotoxic
# writing them to csv
write.csv(AhR_significant, "~/Desktop/BF528/Project 3/AhR_significant.csv", row.names=FALSE)
write.csv(CAR.PXR_significant, "~/Desktop/BF528/Project 3/CAR.PXR_significant.csv", row.names=FALSE)
write.csv(Cytotoxic_significant, "~/Desktop/BF528/Project 3/Cytotoxic_significant.csv", row.names=FALSE)

```

```{r}
### had to go back and fix significant gene files for each group due to the gene_id values went missing :(

AhR_sig <- deseq_results_2$AhR
sig_AhR <- AhR_sig[AhR_sig$AhR_padj<0.05,]
write.csv(sig_AhR, "~/Desktop/BF528/Project 3/significant_AhR_final.csv", row.names=FALSE)

CAR.PXR_sig <- deseq_results_2$`CAR/PXR`
sig_CAR.PXR <- CAR.PXR_sig[CAR.PXR_sig$`CAR/PXR_padj`<0.05,]
write.csv(sig_CAR.PXR, "~/Desktop/BF528/Project 3/significant_CAR.PXR_final.csv", row.names=FALSE)

Cytotoxic_sig <- deseq_results_2$Cytotoxic
sig_Cytotoxic <- Cytotoxic_sig[Cytotoxic_sig$Cytotoxic_padj<0.05,]
write.csv(sig_Cytotoxic, "~/Desktop/BF528/Project 3/significant_Cytotoxic_final.csv", row.names=FALSE)
```

Histogram and Scatter Plot
```{r}
# Histograms of fold change values of significant DE genes
jpeg("AhR_histogram2.jpeg")
hist(sig_AhR$AhR_log2FoldChange, 
     breaks=30, xlim=c(-6, 6),
     main="Significant Differentially Expressed Genes for AhR MOA", xlab="Log2 Fold Change")
yyyy <- sig_CAR.PXR$`CAR/PXR_log2FoldChange`
jpeg("CAR/PXR_histogram2.jpeg")
hist(yyyy, 
     breaks=30, xlim=c(-6, 6),
     main="Significant Differentially Expressed Genes for CAR/PXR MOA", xlab="Log2 Fold Change")

jpeg("Cytotoxic_histogram2.jpeg")
hist(sig_Cytotoxic$Cytotoxic_log2FoldChange, 
     breaks=30, xlim=c(-6, 6),
     main="Significant Differentially Expressed Genes for Cytotoxic MOA", xlab="Log2 Fold Change")
```

```{r}
# scatter plots of fold change vs nominal-pvalue from the significant DE genes
# up and down regulated vectors
up_AhR <- sig_AhR[sig_AhR$AhR_log2FoldChange>0,]
down_AhR <- sig_AhR[sig_AhR$AhR_log2FoldChange<0,]
up_CAR.PXR <- sig_CAR.PXR[sig_CAR.PXR$`CAR/PXR_log2FoldChange`>0,]
down_CAR.PXR <- sig_CAR.PXR[sig_CAR.PXR$`CAR/PXR_log2FoldChange`<0,]
up_Cytotoxic <- sig_Cytotoxic[sig_Cytotoxic$Cytotoxic_log2FoldChange>0,]
down_Cytotoxic <- sig_Cytotoxic[sig_Cytotoxic$Cytotoxic_log2FoldChange<0,]
library(ggplot2)


ggplot()+geom_point(data=up_AhR, aes(x = up_AhR$AhR_log2FoldChange, y = up_AhR$AhR_pvalue), color = "red2")+
  geom_point(data = down_AhR, aes(x = down_AhR$AhR_log2FoldChange, y = down_AhR$AhR_pvalue), color = "blue2")+
  xlab("Log2 Fold Change") + ylab("Nominal P-value")

ggplot()+geom_point(data=up_CAR.PXR, aes(x = up_CAR.PXR$`CAR/PXR_log2FoldChange`, y = up_CAR.PXR$`CAR/PXR_pvalue`), color = "red2")+
  geom_point(data = down_CAR.PXR, aes(x = down_CAR.PXR$`CAR/PXR_log2FoldChange`, y = down_CAR.PXR$`CAR/PXR_pvalue`), color = "blue2")+
  xlab("Log2 Fold Change") + ylab("Nominal P-value")

ggplot()+geom_point(data=up_Cytotoxic, aes(x = up_Cytotoxic$Cytotoxic_log2FoldChange, y = up_Cytotoxic$Cytotoxic_pvalue), color = "red2")+
  geom_point(data = down_Cytotoxic, aes(x = down_Cytotoxic$Cytotoxic_log2FoldChange, y = down_Cytotoxic$Cytotoxic_pvalue), color = "blue2")+
  xlab("Log2 Fold Change") + ylab("Nominal P-value")

```

```{r}
# write out full deseq results for each treatment
write.csv(deseq_results$AhR, "~/Desktop/BF528/Project 3/full_AhR_DESeq2.csv")
write.csv(deseq_results$`CAR/PXR`, "~/Desktop/BF528/Project 3/full_CAR.PXR_DESeq2.csv")
write.csv(deseq_results$Cytotoxic, "~/Desktop/BF528/Project 3/full_Cytotoxic_DESeq2.csv")
```
